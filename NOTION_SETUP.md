# Notion連携セットアップガイド

## 概要

このアプリからNotionの書籍データベースに直接書籍情報を登録できます。

## セットアップ手順

### 1. Notion Integrationの作成

1. https://www.notion.so/my-integrations にアクセス
2. 「+ 新しいインテグレーション」をクリック
3. 以下を設定：
   - 名前: `ISBN Book Reader`（任意）
   - ロゴ: お好みで設定
   - 関連するワークスペース: 使用するワークスペースを選択
4. 「送信」をクリック
5. **Internal Integration Token（シークレット）をコピー**して保存

### 2. Notionデータベースの作成

1. Notionで新しいページを作成
2. 「データベース - フル」を選択
3. 以下のプロパティを作成：

| プロパティ名 | タイプ | 説明 |
|------------|--------|------|
| Name | タイトル | 書籍のタイトル（デフォルトで存在） |
| ISBN | テキストまたは数値 | ISBNコード（テキスト推奨） |
| Author | テキスト | 著者名 |
| Publisher | テキスト | 出版社名 |
| Published | 日付 | 発行日 |
| Pages | 数値 | ページ数 |
| Cover | ファイル＆メディア | 表紙画像（オプション） |

**プロパティ名は英語で、完全に一致させる必要があります**

**注意**:
- ISBNプロパティは「テキスト」タイプを推奨します。「数値」タイプでも動作しますが、先頭のゼロが削除されます。
- Publishedプロパティは「日付」タイプ推奨（カレンダー機能が使える）。「テキスト」タイプでも動作します。
- Pagesプロパティは「数値」タイプ必須。「テキスト」タイプでは動作します（文字列として表示）。
- Coverプロパティ（ファイル＆メディア）はオプションです。作成した場合、表紙画像がプロパティとページカバーの両方に設定されます。

**重要**: これらのプロパティが存在しない場合でもエラーにはなりませんが、対応するデータは登録されません。必ず上記のプロパティを作成してください。

**注意**: Notionのデフォルトタイトルプロパティは「Name」という名前にしてください。

### 3. データベースにIntegrationを招待

1. データベースページの右上「...」→「コネクトの追加」
2. 作成したIntegration（`ISBN Book Reader`）を選択
3. 「招待」をクリック

### 4. データベースIDの取得

データベースのURLから32桁のIDを取得します。

**URLの形式**:
```
https://www.notion.so/your-workspace/DATABASE_ID?v=VIEW_ID
```

**IDの取得方法**:

1. データベースページを開く
2. URLをコピー
3. `?` の前の部分から最後の32文字（英数字のみ）を取得

**例**:

❌ **間違い**（`?` 以降も含めてしまう）:
```
1e1d8e68479381d78152c6def101615c?v=12345
```

✅ **正しい**（32文字の英数字のみ）:
```
1e1d8e68479381d78152c6def101615c
```

**ハイフン付きの場合**:
```
1e1d8e68-4793-81d7-8152-c6def101615c
```
→ ハイフンはあってもなくても自動的に処理されます

**注意**: URLの最後に `?v=...` がある場合は削除してください

### 5. アプリに設定

#### 方法1: アプリの設定タブで入力

1. アプリの「⚙️ 設定」タブを開く
2. 「Notion連携設定」セクションに以下を入力：
   - **Notion API トークン**: Step 1で取得したシークレット
   - **Notion データベースID**: Step 4で取得したID
3. 「Notion設定を保存」をクリック

#### 方法2: .envファイルに保存（永続化）

`.env`ファイルを作成して以下を記述：

```bash
NOTION_API_TOKEN=secret_xxxxxxxxxxxxxxxxxxxxx
NOTION_DATABASE_ID=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

### 6. 使い方

1. ISBNバーコードを読み取る
2. 書籍情報が表示される
3. 「📝 Notionに登録」ボタンをクリック
4. Notionデータベースに自動登録される

## スマートな運用方法

### プロパティのカスタマイズ

基本プロパティ以外にも、以下を追加すると便利です：

| プロパティ名 | タイプ | 用途 |
|------------|--------|------|
| 読了 | チェックボックス | 読み終わったかどうか |
| 評価 | セレクト | ★1〜5の評価 |
| タグ | マルチセレクト | ジャンル分類 |
| メモ | テキスト（長文） | 感想や気づき |
| 購入日 | 日付 | 購入した日付 |
| 読了日 | 日付 | 読み終わった日付 |

### データベースビューの活用

1. **リストビュー**: 全書籍を一覧
2. **ギャラリービュー**: 表紙画像で見やすく
3. **カレンダービュー**: 発行日ベースで表示
4. **フィルター**: 未読のみ、特定の著者など

### 自動化の例

Notionの「自動化」機能を使って：

- 登録時に自動でタグを付与
- 読了チェック時にSlack通知
- 月ごとの読書統計を自動生成

## トラブルシューティング

### エラー: "Notionへの登録に失敗しました"

**原因1**: Integrationがデータベースに招待されていない
- **解決**: Step 3を確認

**原因2**: プロパティ名が一致していない
- **解決**: プロパティ名を完全に一致させる（「名前」「ISBN」など）

**原因3**: APIトークンやデータベースIDが間違っている
- **解決**: 設定を再確認

### プロパティ名をカスタマイズしたい場合

`src/notion_client.py`の`_build_properties`メソッドを編集：

```python
properties["あなたのプロパティ名"] = {
    "rich_text": [
        {"text": {"content": book.title}}
    ]
}
```

## セキュリティ注意事項

- **APIトークンは他人に共有しない**
- `.env`ファイルは`.gitignore`に含まれているため、Gitにコミットされません
- Streamlit Cloud使用時は「Secrets」機能でトークンを管理してください
